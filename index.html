// backend/pipedrive.jsw

import { getSecret } from 'wix-secrets-backend';
import { fetch }    from 'wix-fetch';

/* Map dropdown emails ‚Üí Pipedrive internal user IDs */
const USER_ID_MAP = {
  'thomas.lane@tci-mouldings.com':    21694454,
  'kelly.ballinger@tci-mouldings.com': 23375562,
  'george.preston@tci-mouldings.com':  23310475
};

/**
 * Called by http-functions.js to create a notification on Pipedrive.
 *
 * @param {{
 *   deal_id:    number|string,
 *   recipient:  string,   // one of the keys in USER_ID_MAP (email)
 *   sender:     string,   // name (from clientDropdown)
 *   message:    string
 * }} data
 */
export async function handleContact(data) {
  const token = await getSecret('PIPEDRIVE_API_TOKEN');
  if (!token) {
    throw new Error('Missing PIPEDRIVE_API_TOKEN secret');
  }

  const dealId  = Number(data.deal_id);
  const userId  = USER_ID_MAP[data.recipient];
  const mention = userId ? `@[user:${userId}] ` : '';
  const subject = `${mention}New note from ${data.sender}`;
  const noteBody =
    `**From:** ${data.sender}\n\n` +
    data.message;

  console.log('üöÄ handleContact payload:', { deal_id: dealId, subject, note: noteBody, type: 'note' });

  // 1) Try creating an activity (so @-mention triggers a notification)
  let res = await fetch(
    `https://api.pipedrive.com/v1/activities?api_token=${encodeURIComponent(token)}`,
    {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        deal_id: dealId,
        subject,
        note: noteBody,
        type: 'note'
      })
    }
  );
  let json = await res.json();
  console.log('üåê Pipedrive /activities response ‚Üí', res.status, json);

  if (json.success) {
    return { success: true };
  }

  // 2) Fallback to plain note if activities failed
  console.warn('Activity failed, falling back to notes endpoint:', json.error_info || json.error);
  res = await fetch(
    `https://api.pipedrive.com/v1/notes?api_token=${encodeURIComponent(token)}`,
    {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        deal_id: dealId,
        content: `${mention}${noteBody}`
      })
    }
  );
  json = await res.json();
  console.log('üåê Pipedrive /notes response ‚Üí', res.status, json);

  if (!json.success) {
    throw new Error('Both activity & note failed: ' + JSON.stringify(json));
  }

  return { success: true };
}
